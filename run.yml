#!/usr/local/bin/ansible-playbook --inventory=inventory

- name: ' Konductor UPI '
  hosts: local
  vars:
    module: "build"
    state_provider: "local"
    tf_module_path: "{{ dir_terraform }}/shaman"
    vars_module_path: "{{ dir_terraform }}"
    ansible_name_module: " Konductor | UPI | {{ module }}"
  vars_files:
    - vars/global.yml

    vars_prompt:
      - name: cloud_region
        prompt: "Please enter your AWS region. Example: us-gov-west-1"
        private: no
      - name: aws_access_key
        prompt: "Please enter your AWS Access Key ID"
        private: no
      - name: aws_secret_key
        prompt: "Please enter your AWS Access Key Secret"
        private: no


  tasks:

    - name: '{{ ansible_name_module }} | file | Create ~/.aws'
      file:
        path: "/root/.aws"
        state: directory

        ####### Stage Variables & AWS Creds
        - name: '{{ ansible_name_module }} | template | Terraform Vars & aws credentials'
          template:
            src: "{{ item.name }}"
            dest: "{{ item.dest }}"
            mode: "{{ item.mode }}"
          loop:
            - { mode: '755', name: "templates/terraform/global.tfvars.j2", dest: "{{ tf_module_path }}/global.tfvars"}
            - { mode: '600', name: "templates/aws/credentials.j2", dest: "{{ local_home }}/.aws/credentials"}

    ####### Symlinks
    - name: '{{ ansible_name_module }} | variable | Create variable symlink'
      file:
        src: "{{ tf_module_path }}/variables.tf"
        dest: "{{ item }}"
        state: link
      loop:
        - "{{ tf_module_path }}/elb/variables.tf"
        - "{{ tf_module_path }}/control-plane/variables.tf"